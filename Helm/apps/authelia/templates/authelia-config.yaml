{{- with .Values.authelia }}

apiVersion: v1
kind: ConfigMap
metadata:
    name: authelia-config
    namespace: {{ $.Release.Namespace }}
data:
    users_database.yml: |
        ###############################################################
        #                         Users Database                      #
        ###############################################################

        # This file can be used if you do not have an LDAP set up.

        # List of users
        users:
            stefan:
                displayname: "Stefan Genov"
                password: "$argon2id$v=19$m=65536,t=1,p=8$VzdOeHhKYUFGZFgvV1NNeA$tEJ1BF6dNPy0oCkhaNqYoyzFMX/FP9sy4LXx1L4o49k"   #hash using docker run authelia/authelia:latest YOURNAME hash-password SOMEPASSWORD
                email: sgenov94@gmail.com
                groups:
                    - admins
                    - dev

    configuration.yml: |
        ##############################################################################
        #                   Authelia configuration  thehomelab.wiki                  #
        ##############################################################################
        server:
            host: 0.0.0.0
            port: 9091 # if you need this changed make sure it reflects also in the docker-compose.yml

        log:
            level: info
        jwt_secret: A4gYb7QFpbfKaNWAX7P7FX5y
        default_redirection_url: https://auth.stefangenov.site
        totp:
          issuer: stefangenov.site
          period: 30
          skew: 1

        authentication_backend:
          disable_reset_password: false
          file:
            path: /config/users_database.yml # Make sure this file exists
            password:
              algorithm: argon2id
              iterations: 1
              salt_length: 16
              parallelism: 8
              memory: 64

        access_control:
          default_policy: deny
          rules:
            # Rules applied to everyone
            - domain:
                - "auth.stefangenov.site"
              policy: bypass
            - domain: # Proxies only requiring username and password
                - "dashy.stefangenov.site"
              policy: one_factor
        #    - domain: # Proxies needing 2 factor below
        #        - "proxmox.yourdomain.com"
        #      policy: two_factor
        #      networks:
        #         - 192.168.1.0/24

        session:
          name: authelia_session
          # This secret can also be set using the env variables AUTHELIA_SESSION_SECRET_FILE
          secret: BEcQnvjxawGh4U9JgXBMXNVE
          expiration: 3600 # 1 hour
          inactivity: 7200 # 2 hours
          domain: stefangenov.site # Needs to be your root domain

          redis:
            host: redis.redis.svc.cluster.local
            port: 6379
            # This secret can also be set using the env variables AUTHELIA_SESSION_REDIS_PASSWORD_FILE
            #password: authelia

        regulation:
          max_retries: 5
          find_time: 2m
          ban_time: 10m

        theme: dark   # options: dark, light

        storage:
          local:
            path: /config/db.sqlite3
          encryption_key: A4gYb7QFpbfKaNWAX7P7FX5y

        notifier:
          filesystem:
            filename: /config/notification.txt
        #  smtp:
        #    username: <your-user@your-email-domain.org>
        #    password: <your-user-email-password-for-smtp>
        #    host: <your-email-host-url-or-ip>
        #    port: <your-email-port-for-smtp>  # 25 non-ssl, 443 ssl, 587 tls
        #    sender: <sender@your-email-domain.org>
        #    subject: "[Authelia] {title}"
        #    disable_require_tls: false # set to true if your domain uses no tls or ssl only
        #    disable_html_emails: false # set to true if you don't want html in your emails
        #    tls:
        #      server_name: <your-email-host-url-or-ip>
        #      skip_verify: false
        #      minimum_version: TLS1.2
        {{- end }}