{{ with .Values.authentik }}
apiVersion: apps/v1
kind: Deployment
metadata:
    name: authentik-server
spec:
    replicas: {{ .replicas }}
    selector:
        matchLabels:
            app.kubernetes.io/name: authentik
            app.kubernetes.io/instance: authentik
            app.kubernetes.io/component: "server"
    template:
        metadata:
            labels:
                app.kubernetes.io/name: authentik
                app.kubernetes.io/instance: authentik
                app.kubernetes.io/component: "server"
                app.kubernetes.io/version: "2022.4.1"
        spec:
            volumes:
                - name: geoip-db
                  emptyDir: {}
            serviceAccountName: authentik
            enableServiceLinks: true
            containers:
                - name: authentik
                  image: {{ .image }}
                  imagePullPolicy: "IfNotPresent"
                  args: ["server"]
                  volumeMounts:
                      - name: geoip-db
                        mountPath: /geoip
                  envFrom:
                      - secretRef:
                            name: db
                      - secretRef:
                            name: smtp
                      - secretRef:
                            name: authentik
                  ports:
                      - name: http
                        containerPort: 9000
                        protocol: TCP
                      - name: http-metrics
                        containerPort: 9300
                        protocol: TCP
                      - name: https
                        containerPort: 9443
                        protocol: TCP
                  livenessProbe:
                      httpGet:
                          path: /-/health/live/
                          port: http
                      initialDelaySeconds: 50
                      periodSeconds: 10
                  readinessProbe:
                      httpGet:
                          path: /-/health/ready/
                          port: http
                      initialDelaySeconds: 50
                      periodSeconds: 10
---
# Source: authentik/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    name: authentik-worker
spec:
    replicas: 1
    selector:
        matchLabels:
            app.kubernetes.io/name: authentik
            app.kubernetes.io/instance: authentik
            app.kubernetes.io/component: "worker"
    template:
        metadata:
            labels:
                app.kubernetes.io/name: authentik
                app.kubernetes.io/instance: authentik
                app.kubernetes.io/component: "worker"
                app.kubernetes.io/version: "2022.4.1"
        spec:
            volumes:
                - name: geoip-db
                  emptyDir: {}
            serviceAccountName: authentik
            enableServiceLinks: true
            containers:
                - name: authentik
                  image: "{{ .image }}"
                  imagePullPolicy: "IfNotPresent"
                  args: ["worker"]
                  volumeMounts:
                      - name: geoip-db
                        mountPath: /geoip
                  envFrom:
                      - secretRef:
                            name: db
                      - secretRef:
                            name: smtp
                      - secretRef:
                            name: authentik
---
# Source: authentik/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
    name: authentik
    namespace: {{ $.Release.Namespace }}
spec:
    type: ClusterIP
    ports:
        - port: 9100
          name: http-metrics
          protocol: TCP
          targetPort: http-metrics
        - port: 80
          targetPort: http
          protocol: TCP
          name: http
        - port: 443
          targetPort: https
          protocol: TCP
          name: https
    selector:
        app.kubernetes.io/name: authentik
        app.kubernetes.io/instance: authentik
        app.kubernetes.io/component: "server"
{{- end }}