- hosts: init_master
  name: Setup Longhorn storage
  become: yes
  tags:
      - storage
      - storage-setup-longhorn
  vars_files:
      - "./vars/main.yml"
  tasks:
      - name: Cleanup old potential chart
        file:
            path: longhorn-system
            state: absent

      - name: Ensure new Chart is present
        copy:
            src: ../../../Helm/longhorn-system
            dest: .

      - name: Install longhorn-system namespace
        kubernetes.core.helm:
            name: longhorn-system
            create_namespace: true
            release_namespace: longhorn-system
            chart_ref: longhorn-system/
            values_files: longhorn-system/values.yaml

      - name: Cleanup chart, we no longer need this
        file:
            path: longhorn-system
            state: absent

      - name: Verify everything is in state Running ( This may take a LONG time if you don't have the images and your internet is slow )
        shell: kubectl get po -n longhorn-system | awk '{ print $3 }'
        register: storage_pods_running
        until: storage_pods_running.stdout.find("ContainerCreating") == -1 and storage_pods_running.stdout.find("BackOff") == -1 and storage_pods_running.stdout.find("Error") == -1 and storage_pods_running.stdout.find("Init") == -1
        retries: 360
        delay: 5
        when: verify_running