- hosts: init_master
  name: Setup Jenkins CI/CD
  become: yes
  tags:
      - deploy
      - deploy-jenkins
  vars_files:
      - "./vars/main.yml"
  tasks:
      - name: Cleanup old potential chart
        file:
            path: jenkins-pi
            state: absent

      - name: Ensure new Chart is present
        copy:
            src: ../../../Helm/jenkins-pi
            dest: .

      - name: Install jenkins-pi namespace ( this is SUPER SLOW. Took me ~ 30 minutes. A LOT of disk IOPS is needed to extract jenkins war file and provision plugins, you can check progress if Longhorn dashboard by waiting for pvc to stop growing )
        kubernetes.core.helm:
            name: jenkins-pi
            create_namespace: true
            release_namespace: jenkins-pi
            chart_ref: jenkins-pi/
            values_files: jenkins-pi/values.yaml

      - name: Cleanup chart, we no longer need this
        file:
            path: jenkins-pi
            state: absent
