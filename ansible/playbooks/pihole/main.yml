- hosts: init_master
  name: Setup monitoring with Grafana and Prometheus
  become: yes
  tags:
      - pihole
      - pihole-setup
  tasks:
      - name: Cleanup old potential chart
        file:
            path: pihole
            state: absent

      - name: Ensure new Chart is present
        copy:
            src: ../../../Helm/pihole
            dest: .

      - name: Install pihole namespace ( this will just setup a PV )
        kubernetes.core.helm:
            name: pihole-pv
            create_namespace: true
            release_namespace: pihole
            chart_ref: pihole/
            values_files: pihole/values.yaml

      - name: Add pihole helmchart
        command: "{{ item }}"
        with_items:
            - helm repo add mojo2600 https://mojo2600.github.io/pihole-kubernetes/
            - helm repo update

      - name: Deploy helm chart
        kubernetes.core.helm:
            name: pihole
            create_namespace: false
            release_namespace: pihole
            chart_ref: mojo2600/pihole
            values_files: pihole/values.yaml

      - name: Cleanup chart, we no longer need this
        file:
            path: pihole
            state: absent