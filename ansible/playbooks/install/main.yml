- hosts: all
  name: Setup prereqs
  become: yes
  any_errors_fatal: yes
  tags:
      - preflight
  vars_files:
      - "./vars/main.yml"
  roles:
      - michaelpalacce.helm
      - michaelpalacce.kubernetes_preflight

- hosts: all
  name: Setup Storage dependencies
  become: yes
  tags:
      - preflight
      - preflight-storage-dependencies
  vars_files:
      - "./vars/main.yml"
  tasks:
      - name: Ensure dependencies are installed
        apt:
            name: "{{ packages }}"
            state: present
        vars:
            packages:
                - open-iscsi
                - nfs-common
                - jq

- hosts: init_master
  name: Setup master k3s
  become: yes
  tags:
      - setup
      - setup-init-master
  vars_files:
      - "./vars/main.yml"
  tasks:
      - name: Install k3s
        shell: "{{ item }}"
        with_items:
            - curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE="644" INSTALL_K3S_EXEC="--flannel-backend=none --cluster-cidr=10.40.0.0/16 --disable-network-policy --disable=traefik" sh -
            - cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            - kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

      - name: Get token
        shell: cat /var/lib/rancher/k3s/server/node-token
        register: nodeToken

      - name: Generate join commands
        shell: "echo 'curl -sfL https://get.k3s.io | K3S_URL={{ k3s_master_url }} K3S_TOKEN={{ nodeToken.stdout }} sh -' >> /tmp/join-command"

      - name: Copy output to local files
        fetch:
            src: "{{ item.src }}"
            dest: "{{ item.dest }}"
            flat: yes
        with_items:
            - src: /tmp/join-command
              dest: "{{ output_dir }}/join-command"
            - src: ~/.kube/config
              dest: "{{ output_dir }}/config"

- hosts: workers
  name: Joins all the workers to the cluster
  tags:
      - setup
      - setup-join-workers
  become: yes
  any_errors_fatal: true
  tasks:
      - name: Copy the join command to server location
        copy:
            src: "output/join-command"
            dest: /tmp/join-command.sh
            mode: 0755

      - name: Join the node to cluster
        command: sh /tmp/join-command.sh
