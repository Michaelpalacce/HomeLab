---
- hosts: all
  name: Setup prereqs
  become: yes
  any_errors_fatal: yes
  tags:
      - preflight
  vars_files:
      - "./vars/main.yml"
  roles:
      - michaelpalacce.helm
      - michaelpalacce.kubernetes_preflight

- hosts: all
  name: Setup Logs and log sizes
  become: yes
  gather_facts: false
  tags:
      - preflight
      - preflight-kubelet
  vars_files:
      - "./vars/main.yml"
  tasks:
      - name: Stop kubelet
        systemd:
            state: stopped
            name: kubelet

      - name: Disable kubelet
        shell: systemctl disable kubelet

- hosts: all
  name: Setup Logs and log sizes
  gather_facts: false
  become: yes
  tags:
      - preflight
      - preflight-logs
  vars_files:
      - "./vars/main.yml"
  tasks:
      - name: Logrotate
        copy:
            dest: "{{ item.dest }}"
            src: "{{ item.src }}"
        with_items:
            - dest: /etc/logrotate.d/allContainerLogs
              src: allContainerLogs
            - dest: /etc/logrotate.d/cniLogs
              src: cniLogs
            - dest: /etc/logrotate.d/podLogs
              src: podLogs

      - name: Limit Journalctl max size
        command: "journalctl --vacuum-size={{ journalctl_vaccum_size }}"
        register: logrotate_stat

      - name: Check if logrotate is daily
        stat: path=/etc/cron.daily/logrotate
        register: logrotate_stat

      - name: Move logrotate to hourly if daily
        command: mv /etc/cron.daily/logrotate /etc/cron.hourly/logrotate
        when: logrotate_stat.stat.exists

- hosts: all
  name: Setup Storage dependencies
  become: yes
  gather_facts: false
  tags:
      - preflight
      - preflight-storage-dependencies
  vars_files:
      - "./vars/main.yml"
  tasks:
      - name: Ensure dependencies are installed
        apt:
            name: "{{ packages }}"
            state: present
        vars:
            packages:
                - open-iscsi
                - nfs-common
                - jq

- hosts:
    - master
    - workers
  become: true
  any_errors_fatal: true
  tags:
      - setup
      - setup-k3s
  vars_files:
      - "./vars/main.yml"
  roles:
      - xanmanning.k3s

- hosts: master
  name: Setup master k3s calico and fetch config
  become: yes
  tags:
      - setup
      - setup-init-master
  vars_files:
      - "./vars/main.yml"
  tasks:

      - name: Setup k3s and setup calico CNI
        shell: "{{ item }}"
        with_items:
            - mkdir -p ~/.kube
            - cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            - kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

      - name: Copy output to local files
        fetch:
            src: "{{ item.src }}"
            dest: "{{ item.dest }}"
            flat: yes
        with_items:
            - src: /etc/rancher/k3s/k3s.yaml
              dest: "{{ output_dir }}/config"

- hosts: all
  name: Fix Multipath
  become: yes
  tags:
      - init
      - init_multipath
  tasks:
      - name: Make sure multipath conf file is missing
        file:
            path: /etc/multipath.conf
            state: absent

      - name: Copy Multipath File
        copy:
            src: ./files/multipath.conf
            dest: /etc/multipath.conf

      - name: Restart multipath service
        systemd:
            state: restarted
            name: multipathd
