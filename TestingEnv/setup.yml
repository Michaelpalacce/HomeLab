- hosts: all
  tags:
      - preflight
  become: yes
  vars_files:
      - "./vars/setup.yml"
  roles:
      - michaelpalacce.docker
      - michaelpalacce.helm
      - michaelpalacce.kubernetes_preflight

- hosts: master
  tags:
      - setup
      - setup_master
  become: yes
  vars_files:
      - "./vars/setup.yml"
  roles:
      - michaelpalacce.kubernetes_cluster

- hosts: workers
  name: Joins all the workers to the cluster
  tags:
      - init
      - init_join_workers
  become: yes
  vars_files:
      - "./vars/setup.yml"
  any_errors_fatal: true
  tasks:
      - name: Attempt to check if this node can join a cluster. Don't do anything if preflight checks cannot pass
        command: kubeadm init phase preflight
        ignore_errors: yes
        register: preflight

      - name: Copy the join command to server location
        copy:
            src: "{{ output_dir }}/join-command"
            dest: /tmp/join-command.sh
            mode: 0777
        when: preflight.rc == 0

      - name: Join the node to cluster
        command: sh /tmp/join-command.sh
        when: preflight.rc == 0