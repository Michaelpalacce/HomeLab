---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: authentik
    namespace: authentik
spec:
    interval: 5m
    install:
        createNamespace: true
        crds: CreateReplace
        remediation:
          retries: 3
    upgrade:
        crds: CreateReplace
        remediation:
          retries: 3
    chart:
        spec:
            chart: authentik
            version: 2022.4.1
            interval: 5m
            sourceRef:
                kind: HelmRepository
                name: authentik
                namespace: flux-system
    values:
        env:
            - name: AUTHENTIK_EMAIL__HOST
            - name: AUTHENTIK_EMAIL__PORT
            - name: AUTHENTIK_EMAIL__USERNAME
            - name: AUTHENTIK_EMAIL__PASSWORD
            - name: AUTHENTIK_EMAIL__USE_SSL
            - name: AUTHENTIK_EMAIL__FROM
            - name: AUTHENTIK_POSTGRESQL__HOST
            - name: AUTHENTIK_POSTGRESQL__USER
            - name: AUTHENTIK_POSTGRESQL__PASSWORD
            - name: AUTHENTIK_POSTGRESQL__NAME
            - name: AUTHENTIK_REDIS__HOST
            - name: AUTHENTIK_SECRET_KEY
        envFrom:
            - secretRef:
                  name: db
            - secretRef:
                  name: smtp
            - secretRef:
                  name: authentik
        ingress:
            enabled: true
            tls:
                - hosts:
                      - "*.stefangenov.site"
                  secretName: ingress
            hosts:
                - host: authentik.stefangenov.site
                  paths:
                      - path: "/"
                        pathType: Prefix
