---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: velero
    namespace: velero
spec:
    interval: 5m
    install:
        createNamespace: true
        crds: CreateReplace
        remediation:
            retries: 3
    upgrade:
        crds: CreateReplace
        remediation:
            retries: 3
    chart:
        spec:
            chart: velero
            version: 3.1.2
            interval: 5m
            sourceRef:
                kind: HelmRepository
                name: velero
                namespace: flux-system
    values:
        upgradeCRDs: true
        kubectl:
            image:
                repository: stefangenov/kubectl
                tag: v1.25.3
        initContainers:
            - name: velero-plugin-for-aws
              image: velero/velero-plugin-for-aws:v1.6.1
              volumeMounts:
                  - mountPath: /target
                    name: plugins
        metrics:
            enabled: true
            scrapeInterval: 120s
            scrapeTimeout: 30s
        deployNodeAgent: true
        credentials:
            existingSecret: cloud-credentials-backblaze
        configuration:
            provider: aws
            backupStorageLocation:
                bucket: sgenov
                config:
                    region: eu-central-003
                    s3ForcePathStyle: true
                    s3Url: https://s3.eu-central-003.backblazeb2.com
            volumeSnapshotLocation:
                config:
                    region: eu-central-003
