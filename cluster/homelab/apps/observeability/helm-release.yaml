---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: observeability
    namespace: observeability
spec:
    interval: 1h
    install:
        createNamespace: true
    chart:
        spec:
            chart: kube-prometheus-stack
            version: 77.10.0
            interval: 1h
            sourceRef:
                kind: HelmRepository
                name: kube-prometheus-stack
                namespace: flux-system
    values:


    ## Create default rules for monitoring the cluster
    ##
    defaultRules:
      create: true
      rules:
        alertmanager: true
        etcd: true
        configReloaders: true
        general: true
        k8sContainerCpuUsageSecondsTotal: true
        k8sContainerMemoryCache: true
        k8sContainerMemoryRss: true
        k8sContainerMemorySwap: true
        k8sContainerResource: true
        k8sContainerMemoryWorkingSetBytes: true
        k8sPodOwner: true
        kubeApiserverAvailability: true
        kubeApiserverBurnrate: true
        kubeApiserverHistogram: true
        kubeApiserverSlos: true
        kubeControllerManager: false
        kubelet: true
        kubeProxy: false
        kubePrometheusGeneral: true
        kubePrometheusNodeRecording: true
        kubernetesApps: true
        kubernetesResources: true
        kubernetesStorage: true
        kubernetesSystem: true
        kubeSchedulerAlerting: false
        kubeSchedulerRecording: false
        kubeStateMetrics: true
        network: true
        node: true
        nodeExporterAlerting: true
        nodeExporterRecording: true
        prometheus: true
        prometheusOperator: true
        windows: false
      prometheus:
        prometheusSpec:
          scrapeInterval: 60s
          scrapeTimeout: 30s
          image:
            registry: quay.io
            repository: prometheus/prometheus
            tag: v3.5.0
            sha: ""
            pullPolicy: IfNotPresent
          retention: 10d
          retentionSize: 50GiB

          storageSpec:
            volumeClaimTemplate:
              spec:
                storageClassName: longhorn
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: 55Gi
        ingress:
          enabled: true
          ingressClassName: nginx
          hosts: 
            - prometheus.sgenov.dev

          paths: []

          tls:
          - secretName: ingress
            hosts:
              - "*.sgenov.dev"

      alertmanager:
        alertmanagerSpec:
          image:
            registry: quay.io
            repository: prometheus/alertmanager
            tag: v0.28.1
            sha: ""
            pullPolicy: IfNotPresent
            ## Storage is the definition of how storage will be used by the Alertmanager instances.
            ## ref: https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/platform/storage.md
            ##
          storage: 
            volumeClaimTemplate:
              spec:
                storageClassName: longhorn
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: 10Gi
        ingress:
          enabled: true
          ingressClassName: nginx

          annotations: {}
            # kubernetes.io/ingress.class: nginx
            # kubernetes.io/tls-acme: "true"

          hosts: 
            - alertmanager.sgenov.dev

          path: /

          tls:
          - secretName: ingress
            hosts:
              - "*.sgenov.dev"
      grafana:
        persistence:
          enabled: true
          type: sts
          storageClassName: "longhorn"
          accessModes:
            - ReadWriteOnce
          size: 20Gi
          finalizers:
            - kubernetes.io/pvc-protection
        ingress:
          ## If true, Grafana Ingress will be created
          ##
          enabled: true
          ingressClassName: nginx

          annotations: {}
            # kubernetes.io/ingress.class: nginx
            # kubernetes.io/tls-acme: "true"

          hosts: 
            - grafana.sgenov.dev

          path: /

          tls:
          - secretName: ingress
            hosts:
              - "*.sgenov.dev"
      crds:
        enabled: true
        ## The CRD upgrade job mitigates the limitation of helm not being able to upgrade CRDs.
        ## The job will apply the CRDs to the cluster before the operator is deployed, using helm hooks.
        ## It deploy a corresponding clusterrole, clusterrolebinding and serviceaccount to apply the CRDs.
        ## This feature is in preview, off by default and may change in the future.
        upgradeJob:
          enabled: true
          forceConflicts: false
