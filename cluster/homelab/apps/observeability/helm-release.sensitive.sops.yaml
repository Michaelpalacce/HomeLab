apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: observeability
    namespace: observeability
spec:
    interval: 1h
    install:
        createNamespace: true
    chart:
        spec:
            chart: kube-prometheus-stack
            version: 78.4.0
            interval: 1h
            sourceRef:
                kind: HelmRepository
                name: kube-prometheus-stack
                namespace: flux-system
    values:
        defaultRules:
            create: true
            rules:
                alertmanager: true
                etcd: true
                configReloaders: true
                general: true
                k8sContainerCpuUsageSecondsTotal: true
                k8sContainerMemoryCache: true
                k8sContainerMemoryRss: true
                k8sContainerMemorySwap: true
                k8sContainerResource: true
                k8sContainerMemoryWorkingSetBytes: true
                k8sPodOwner: true
                kubeApiserverAvailability: true
                kubeApiserverBurnrate: true
                kubeApiserverHistogram: true
                kubeApiserverSlos: true
                kubeControllerManager: false
                kubelet: true
                kubeProxy: false
                kubePrometheusGeneral: true
                kubePrometheusNodeRecording: true
                kubernetesApps: true
                kubernetesResources: true
                kubernetesStorage: true
                kubernetesSystem: true
                kubeSchedulerAlerting: false
                kubeSchedulerRecording: false
                kubeStateMetrics: true
                network: true
                node: true
                nodeExporterAlerting: true
                nodeExporterRecording: true
                prometheus: true
                prometheusOperator: true
                windows: false
        prometheus-node-exporter:
            containerSecurityContext:
                readOnlyRootFilesystem: true
                capabilities:
                    drop:
                        - ALL
        # prometheusOperator:
        #   networkPolicy:
        #       enabled: true
        prometheus:
            # networkPolicy:
            #     enabled: true
            prometheusSpec:
                scrapeInterval: 60s
                scrapeTimeout: 30s
                retention: 10d
                retentionSize: 10GiB
                storageSpec:
                    volumeClaimTemplate:
                        spec:
                            storageClassName: longhorn
                            accessModes:
                                - ReadWriteOnce
                            resources:
                                requests:
                                    storage: 15Gi
                serviceMonitorNamespaceSelector:
                    matchLabels:
                        monitoring.coreos.com/serviceMonitor: "true"
            ingress:
                enabled: true
                ingressClassName: nginx
                hosts:
                    - prometheus.sgenov.dev
                paths: []
                tls:
                    - secretName: ingress
                      hosts:
                        - '*.sgenov.dev'
        alertmanager:
            # networkPolicy:
            #     enabled: true
            config:
                global:
                    resolve_timeout: 5m
                inhibit_rules:
                    - source_matchers:
                        - severity = critical
                      target_matchers:
                        - severity =~ warning|info
                      equal:
                        - namespace
                        - alertname
                    - source_matchers:
                        - severity = warning
                      target_matchers:
                        - severity = info
                      equal:
                        - namespace
                        - alertname
                    - source_matchers:
                        - alertname = InfoInhibitor
                      target_matchers:
                        - severity = info
                      equal:
                        - namespace
                    - target_matchers:
                        - alertname = InfoInhibitor
                route:
                    group_by:
                        - alertname
                        - namespace
                    group_wait: 30s
                    group_interval: 5m
                    repeat_interval: 12h
                    receiver: discord
                    routes:
                        - receiver: "null"
                          matchers:
                            - alertname="PrometheusDuplicateTimestamps"
                          continue: false
                        - receiver: "null"
                          matchers:
                            - alertname="Watchdog"
                          continue: false
                        # Match everything else
                        - receiver: discord
                receivers:
                    - name: "null"
                    - name: discord
                      discord_configs:
                        - webhook_url: ENC[AES256_GCM,data:a4rBBVcMCC7JATZEBUlwEqO+I3r8oxPlThw8GcWFwwW+GzWE8FC3i898qI+SxJKrRbi/149G4NM25oiqt7suHrhytdgHJP+4Hp3YOsrDPeKA9XROhOVtIiqcXyXnr5Luvlknif+7s5vqfSOniDqt8Kkipje0DTGCpg==,iv:Z5jNIMuiPMieMl80ReD/NCIc9ZYIaEvues76wHdUsKU=,tag:8XouyQRIxVNKIoUHNK244Q==,type:str]
                          send_resolved: true
                templates:
                    - /etc/alertmanager/config/*.tmpl
            alertmanagerSpec:
                alertmanagerConfigSelector:
                    matchLabels:
                        # This is so we can create AlertManager configs targeting `default`
                        alertmanagerConfig: default
                storage:
                    volumeClaimTemplate:
                        spec:
                            storageClassName: longhorn
                            accessModes:
                                - ReadWriteOnce
                            resources:
                                requests:
                                    storage: 5Gi
            ingress:
                enabled: true
                ingressClassName: nginx
                annotations:
                    gethomepage.dev/enabled: "true"
                    gethomepage.dev/description: Handles Prometheus Alerts
                    gethomepage.dev/group: Monitoring
                    gethomepage.dev/icon: alertmanager
                    gethomepage.dev/name: Alertmanager
                hosts:
                    - alertmanager.sgenov.dev
                path: /
                tls:
                    - secretName: ingress
                      hosts:
                        - '*.sgenov.dev'
        grafana:
            adminUser: admin
            adminPassword: ENC[AES256_GCM,data:MUll4rYAbO+eg7XaxvLh4uA9xF1cUEoreDUDLqmvawQAQ1tAPeV4DgMm4Qc65aZTDm2vOw==,iv:3lPtIC17fJFYEcKwPfUtxbMzKJAoBYnQr7M9P73WU+Q=,tag:PvoMziKEK4n93DnUiN9Usg==,type:str]
            persistence:
                enabled: true
                type: sts
                storageClassName: longhorn
                accessModes:
                    - ReadWriteOnce
                size: 2Gi
                finalizers:
                    - kubernetes.io/pvc-protection
            ingress:
                ## If true, Grafana Ingress will be created
                ##
                enabled: true
                ingressClassName: nginx
                annotations:
                    gethomepage.dev/enabled: "true"
                    gethomepage.dev/description: Nice observeability graphs.
                    gethomepage.dev/group: Monitoring
                    gethomepage.dev/icon: grafana
                    gethomepage.dev/name: Grafana
                    gethomepage.dev/widget.type: grafana
                    gethomepage.dev/widget.url: https://grafana.sgenov.dev
                    gethomepage.dev/widget.version: "2"
                    gethomepage.dev/widget.alerts: alertmanager
                    gethomepage.dev/widget.username: admin
                    gethomepage.dev/widget.password: ENC[AES256_GCM,data:P4/RzmiJKOq6d2fPwDXMWbVZ8o4ttcw3r5MNF/P9Qjs3EK3+oXskU/I0pfn/OOkcRCRkkA==,iv:lvc4Fc1Y7NT/UShyZbQ7V6rdE8Cdt2fg4m8zO9pqtKY=,tag:wF++3KVayPHB2NCvwcm+1A==,type:str]
                hosts:
                    - grafana.sgenov.dev
                path: /
                tls:
                    - secretName: ingress
                      hosts:
                        - '*.sgenov.dev'
        crds:
            enabled: true
            ## The CRD upgrade job mitigates the limitation of helm not being able to upgrade CRDs.
            ## The job will apply the CRDs to the cluster before the operator is deployed, using helm hooks.
            ## It deploy a corresponding clusterrole, clusterrolebinding and serviceaccount to apply the CRDs.
            ## This feature is in preview, off by default and may change in the future.
            upgradeJob:
                enabled: true
                forceConflicts: false
            image:
                busybox:
                    registry: docker.io
                    repository: busybox
                    tag: "1.37"
                    sha: ""
                    pullPolicy: IfNotPresent
                kubectl:
                    registry: registry.k8s.io
                    repository: kubectl
                    # defaults to the Kubernetes version
                    tag: ""
                    sha: ""
                    pullPolicy: IfNotPresent
sops:
    age:
        - recipient: age1mq6usjzvvxvcp7tl03yjdqd0kgjhhvhz48kmg86p43nhx0jc75jssw0kfn
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBqQVJuVkl3Q3ByVExGelo3
            VDg3S0JOZjFLeVh3RXhZVkZXVTNxekZYQms0CmZScWdwV2JVRkt3RnB0TkR4aGxI
            dUJhc2dkR2YzOU1GWGVvbmtzTFg0Y2sKLS0tIGZYdFJONU9URVRDUjZaa1Vibm9v
            RE5CdjRadDdBUUFzUTEzbGw0RlFWVmsK9R8Ir+yjzzdmG2+YKE0/w1iZtvUO2UVO
            rEpqPU9hTWXrCZv4jveIzUvp8vHxvD2zQUDp4Jkzon4IDdVGk8V4qA==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-10-24T17:30:24Z"
    mac: ENC[AES256_GCM,data:ot6nexffZZH+CZQy9zTaHegT6hrDIsshzFHCPAElfnluOoaSzI1V7SMO3Hb7vpRKXkChiY9zKRKr6q0/hr9d+GKhNZLMIMIwuBPLyT3KQkQKNEgfDojiWD/0RIhrG0Mk47HeKiWYbhgNLhtP0CREvhfrVWZGIheZqJTfVOpj6mQ=,iv:EUa2uxFzJz9iosJxOc+tzrK0Nx03knsDqPXRhcKXfqg=,tag:FwC49qSv9+ES2Ho2XI2fMQ==,type:str]
    encrypted_regex: (?i)password|webhook_url|token|key
    version: 3.11.0
