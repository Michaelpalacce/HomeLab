apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: observeability
    namespace: observeability
spec:
    interval: 1h
    install:
        createNamespace: true
    chart:
        spec:
            chart: kube-prometheus-stack
            version: 78.3.2
            interval: 1h
            sourceRef:
                kind: HelmRepository
                name: kube-prometheus-stack
                namespace: flux-system
    values:
        defaultRules:
            create: true
            rules:
                alertmanager: true
                etcd: true
                configReloaders: true
                general: true
                k8sContainerCpuUsageSecondsTotal: true
                k8sContainerMemoryCache: true
                k8sContainerMemoryRss: true
                k8sContainerMemorySwap: true
                k8sContainerResource: true
                k8sContainerMemoryWorkingSetBytes: true
                k8sPodOwner: true
                kubeApiserverAvailability: true
                kubeApiserverBurnrate: true
                kubeApiserverHistogram: true
                kubeApiserverSlos: true
                kubeControllerManager: false
                kubelet: true
                kubeProxy: false
                kubePrometheusGeneral: true
                kubePrometheusNodeRecording: true
                kubernetesApps: true
                kubernetesResources: true
                kubernetesStorage: true
                kubernetesSystem: true
                kubeSchedulerAlerting: false
                kubeSchedulerRecording: false
                kubeStateMetrics: true
                network: true
                node: true
                nodeExporterAlerting: true
                nodeExporterRecording: true
                prometheus: true
                prometheusOperator: true
                windows: false
        prometheus-node-exporter:
            containerSecurityContext:
                readOnlyRootFilesystem: true
                capabilities:
                    drop:
                        - ALL
        # prometheusOperator:
        #   networkPolicy:
        #       enabled: true
        prometheus:
            # networkPolicy:
            #     enabled: true
            prometheusSpec:
                scrapeInterval: 60s
                scrapeTimeout: 30s
                retention: 10d
                retentionSize: 10GiB
                storageSpec:
                    volumeClaimTemplate:
                        spec:
                            storageClassName: longhorn
                            accessModes:
                                - ReadWriteOnce
                            resources:
                                requests:
                                    storage: 15Gi
                serviceMonitorNamespaceSelector:
                    matchLabels:
                        monitoring.coreos.com/serviceMonitor: "true"
            ingress:
                enabled: true
                ingressClassName: nginx
                hosts:
                    - prometheus.sgenov.dev
                paths: []
                tls:
                    - secretName: ingress
                      hosts:
                        - '*.sgenov.dev'
        alertmanager:
            # networkPolicy:
            #     enabled: true
            config:
                global:
                    resolve_timeout: 5m
                inhibit_rules:
                    - source_matchers:
                        - severity = critical
                      target_matchers:
                        - severity =~ warning|info
                      equal:
                        - namespace
                        - alertname
                    - source_matchers:
                        - severity = warning
                      target_matchers:
                        - severity = info
                      equal:
                        - namespace
                        - alertname
                    - source_matchers:
                        - alertname = InfoInhibitor
                      target_matchers:
                        - severity = info
                      equal:
                        - namespace
                    - target_matchers:
                        - alertname = InfoInhibitor
                route:
                    group_by:
                        - alertname
                        - namespace
                    group_wait: 30s
                    group_interval: 5m
                    repeat_interval: 12h
                    receiver: discord
                    routes:
                        - receiver: "null"
                          matchers:
                            - alertname="PrometheusDuplicateTimestamps"
                          continue: false
                        - receiver: "null"
                          matchers:
                            - alertname="Watchdog"
                          continue: false
                        # Match everything else
                        - receiver: discord
                receivers:
                    - name: "null"
                    - name: discord
                      discord_configs:
                        - webhook_url: ENC[AES256_GCM,data:Noi0PNRn5G/gdZhCzQILfCtYhJqwjbCciBHaZo8QbMnSpWmz8+xIcERMqPAjeikZFvjcIJSr+drhIa9Mpc+v9sUEnU3Y+lYT2uT/Nt7KRvLiZZBkeeXB6LnjIXEjde48SoGjSTs3i5QoS4NqIfcGMfZKIcq7ENrW6A==,iv:XmYF+Pd4+fqMt9UUKg8E4xuASi5DmSPAAWstbEp9GV8=,tag:/APnyPsWIY9PmHpj/+YqEw==,type:str]
                          send_resolved: true
                templates:
                    - /etc/alertmanager/config/*.tmpl
            alertmanagerSpec:
                alertmanagerConfigSelector:
                    matchLabels:
                        # This is so we can create AlertManager configs targeting `default`
                        alertmanagerConfig: default
                storage:
                    volumeClaimTemplate:
                        spec:
                            storageClassName: longhorn
                            accessModes:
                                - ReadWriteOnce
                            resources:
                                requests:
                                    storage: 5Gi
            ingress:
                enabled: true
                ingressClassName: nginx
                annotations:
                    gethomepage.dev/enabled: "true"
                    gethomepage.dev/description: Handles Prometheus Alerts
                    gethomepage.dev/group: Monitoring
                    gethomepage.dev/icon: alertmanager
                    gethomepage.dev/name: Alertmanager
                hosts:
                    - alertmanager.sgenov.dev
                path: /
                tls:
                    - secretName: ingress
                      hosts:
                        - '*.sgenov.dev'
        grafana:
            adminUser: admin
            adminPassword: ENC[AES256_GCM,data:kNvmoAYyXRRibvlwSsG9rUZ+WXrYQzfGEu7sy7iw2nZMWyJIXR2M1dC50B2MIE8iNz55hg==,iv:zEiqGiwKuFJDAO9hahH8EipTzpEbRSkVqd/pJKa0wX0=,tag:a/lUXXEjEZ1aItb1imtriw==,type:str]
            persistence:
                enabled: true
                type: sts
                storageClassName: longhorn
                accessModes:
                    - ReadWriteOnce
                size: 2Gi
                finalizers:
                    - kubernetes.io/pvc-protection
            ingress:
                ## If true, Grafana Ingress will be created
                ##
                enabled: true
                ingressClassName: nginx
                annotations:
                    gethomepage.dev/enabled: "true"
                    gethomepage.dev/description: Nice observeability graphs.
                    gethomepage.dev/group: Monitoring
                    gethomepage.dev/icon: grafana
                    gethomepage.dev/name: Grafana
                    gethomepage.dev/widget.type: grafana
                    gethomepage.dev/widget.url: https://grafana.sgenov.dev
                    gethomepage.dev/widget.version: "2"
                    gethomepage.dev/widget.alerts: alertmanager
                    gethomepage.dev/widget.username: admin
                    gethomepage.dev/widget.password: ENC[AES256_GCM,data:cC+9O7GPpESlnag+Z2+Sn5OisWLfUNo6yNQUOn4Cba3VD1cyC9ycFvLofr+h3fMygVMO9g==,iv:iR2DMbGcbfG+wCC1PZ96HqbXWcArCz19F2IG3pTXlbg=,tag:4zch6U6sHp2D486QmzAFoA==,type:str]
                hosts:
                    - grafana.sgenov.dev
                path: /
                tls:
                    - secretName: ingress
                      hosts:
                        - '*.sgenov.dev'
        crds:
            enabled: true
            ## The CRD upgrade job mitigates the limitation of helm not being able to upgrade CRDs.
            ## The job will apply the CRDs to the cluster before the operator is deployed, using helm hooks.
            ## It deploy a corresponding clusterrole, clusterrolebinding and serviceaccount to apply the CRDs.
            ## This feature is in preview, off by default and may change in the future.
            upgradeJob:
                enabled: true
                forceConflicts: false
sops:
    age:
        - recipient: age1mq6usjzvvxvcp7tl03yjdqd0kgjhhvhz48kmg86p43nhx0jc75jssw0kfn
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBVR1pqSjhzNmpuNS8ybi9L
            Uk9ZejdzMWorT3pENVVPSUJTU0UyeERoWFY4CkIzT0c0N2lCOFdMa3ZUcVQrK3ov
            L3lKT2hGZDM5Z3dPdmY3ZjFrNlZrN2sKLS0tIFBNd1JXZVJwYUJYdUM0N2RtVDZl
            RWJHTk9CQkxuYm1qZmtRTGo3YWxXNk0Kw/0WFpDD2DlDrttlbG3tChrpVSCqsdcy
            xTthG+pdLC8HIzZ3onZC/L6/OXachWFe2R2ImwDVleR8q1CtdUddbg==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-09-25T16:48:34Z"
    mac: ENC[AES256_GCM,data:e9WYdIQgDncaAJe5qqhjRWeVNkYZYsyDRodnsOX2X/QtEjMkH68cpe+qfPZQj255kBkC3v28vtyYkvdhXnNRP/Ju4AsILvqZIyM6wGrE7k33td52yBT2vYQs9OEwihxufOlqjyeik7CPmHA1feT+6PRGXIl6JCy3VOnKWffCRqA=,iv:znnjuHOWmXwhwLvM8AA7hVck2v6Xeb0RywLw0eYOklY=,tag:AkcutpW8f02I1JT+0TQ3EQ==,type:str]
    encrypted_regex: (?i)password|webhook_url|token|key
    version: 3.10.2
