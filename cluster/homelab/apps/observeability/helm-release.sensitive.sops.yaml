apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: observeability
  namespace: observeability
spec:
  interval: 10m
  install:
    createNamespace: true
  chart:
    spec:
      chart: kube-prometheus-stack
      version: 82.2.1
      interval: 10m
      sourceRef:
        kind: HelmRepository
        name: kube-prometheus-stack
        namespace: flux-system
  values:
    defaultRules:
      create: true
      rules:
        alertmanager: true
        etcd: true
        configReloaders: true
        general: true
        k8sContainerCpuUsageSecondsTotal: true
        k8sContainerMemoryCache: true
        k8sContainerMemoryRss: true
        k8sContainerMemorySwap: true
        k8sContainerResource: true
        k8sContainerMemoryWorkingSetBytes: true
        k8sPodOwner: true
        kubeApiserverAvailability: true
        kubeApiserverBurnrate: true
        kubeApiserverHistogram: true
        kubeApiserverSlos: true
        kubeControllerManager: false
        kubelet: true
        kubeProxy: false
        kubePrometheusGeneral: true
        kubePrometheusNodeRecording: true
        kubernetesApps: true
        kubernetesResources: true
        kubernetesStorage: true
        kubernetesSystem: true
        kubeSchedulerAlerting: false
        kubeSchedulerRecording: false
        kubeStateMetrics: true
        network: true
        node: true
        nodeExporterAlerting: true
        nodeExporterRecording: true
        prometheus: true
        prometheusOperator: true
        windows: false
    prometheus-node-exporter:
      containerSecurityContext:
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL
    prometheus:
      prometheusSpec:
        scrapeInterval: 60s
        scrapeTimeout: 30s
        retention: 30d
        retentionSize: 10GiB
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: longhorn
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 15Gi
        serviceMonitorNamespaceSelector:
          matchLabels:
            monitoring.coreos.com/serviceMonitor: "true"
      route:
        main:
          # -- Enables or disables the route
          enabled: true
          apiVersion: gateway.networking.k8s.io/v1
          kind: HTTPRoute
          annotations:
            gethomepage.dev/enabled: "true"
            gethomepage.dev/description: Metrics Aggregator.
            gethomepage.dev/group: Monitoring
            gethomepage.dev/icon: prometheus
            gethomepage.dev/name: Prometheus
          hostnames:
            - prometheus.sgenov.dev
          parentRefs:
            - name: internal
              namespace: istio-gateway
          matches:
            - path:
                type: PathPrefix
                value: /
    alertmanager:
      config:
        global:
          resolve_timeout: 5m
        inhibit_rules:
          - source_matchers:
              - severity = critical
            target_matchers:
              - severity =~ warning|info
            equal:
              - namespace
              - alertname
          - source_matchers:
              - severity = warning
            target_matchers:
              - severity = info
            equal:
              - namespace
              - alertname
          - source_matchers:
              - alertname = InfoInhibitor
            target_matchers:
              - severity = info
            equal:
              - namespace
          - target_matchers:
              - alertname = InfoInhibitor
        route:
          group_by:
            - alertname
            - namespace
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 12h
          receiver: discord
          routes:
            - receiver: "null"
              matchers:
                - alertname="PrometheusDuplicateTimestamps"
              continue: false
            - receiver: "null"
              matchers:
                - alertname="Watchdog"
              continue: false
            - receiver: "null"
              matchers:
                - alertname="InfoInhibitor"
              continue: false
            # Match everything else
            - receiver: discord
        receivers:
          - name: "null"
          - name: discord
            discord_configs:
              - webhook_url: ENC[AES256_GCM,data:X3JPxmLya1DAXOcF2Wye04dWuT0d5mnwarj04DL1OE5yZFCojauRzcQIF2JNV5Z4lJBWZD5LQuTQ991OS/RBCKBa3zNjoZAP1xFifGfDxTGUxEfszmNpey6porPa7jK+1bRVS7dZX7ZUIEY4Cyg8wfE9TPFDz1jKCQ==,iv:FUy+psbXPk7/m60Ui4p1ERn/mdadI+kRTatdKLAAHEE=,tag:hkUPZmQyDJ1QuRZOrBeiog==,type:str]
                send_resolved: true
        templates:
          - /etc/alertmanager/config/*.tmpl
      alertmanagerSpec:
        alertmanagerConfigSelector:
          matchLabels:
            # This is so we can create AlertManager configs targeting `default`
            alertmanagerConfig: default
        storage:
          volumeClaimTemplate:
            spec:
              storageClassName: longhorn
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 5Gi
      route:
        main:
          # -- Enables or disables the route
          enabled: true
          apiVersion: gateway.networking.k8s.io/v1
          kind: HTTPRoute
          annotations:
            gethomepage.dev/enabled: "true"
            gethomepage.dev/description: Handles Prometheus Alerts
            gethomepage.dev/group: Monitoring
            gethomepage.dev/icon: alertmanager
            gethomepage.dev/name: Alertmanager
          hostnames:
            - alertmanager.sgenov.dev
          parentRefs:
            - name: internal
              namespace: istio-gateway
          matches:
            - path:
                type: PathPrefix
                value: /
    grafana:
      adminUser: admin
      adminPassword: ENC[AES256_GCM,data:W9cc+RM2pJtf/ce61cziwq0pNM4Aro8O240P11xu4MRXNwcAyywK9n0EyBtQGHauZM+t7g==,iv:xZEhDmF+9p5ILOgCUH9yA7uVxFucsjbAnJajTBdlxE8=,tag:dDAMCmNwX2oSzHAVliHjnA==,type:str]
      persistence:
        enabled: true
        type: sts
        storageClassName: longhorn
        accessModes:
          - ReadWriteOnce
        size: 2Gi
        finalizers:
          - kubernetes.io/pvc-protection
      route:
        main:
          # -- Enables or disables the route
          enabled: true
          apiVersion: gateway.networking.k8s.io/v1
          kind: HTTPRoute
          annotations: null
          gethomepage.dev/enabled: "true"
          gethomepage.dev/description: Nice observeability graphs.
          gethomepage.dev/group: Monitoring
          gethomepage.dev/icon: grafana
          gethomepage.dev/name: Grafana
          gethomepage.dev/widget.type: grafana
          gethomepage.dev/widget.url: https://grafana.sgenov.dev
          gethomepage.dev/widget.version: "2"
          gethomepage.dev/widget.alerts: alertmanager
          gethomepage.dev/widget.username: admin
          gethomepage.dev/widget.password: ENC[AES256_GCM,data:/h9MONsjnnynnvz6uTHbgS2s20R09kfhbTUj6CZsCz/Daq00ZnLTRb5ZmDfqFe4Yu+xsXQ==,iv:EkzGmmbeIP9SuB+RbBsypNPEg0xQb3kSpNvdXXdavBo=,tag:tPN9Rahh1fOQiG26YOUuuw==,type:str]
          hostnames:
            - grafana.sgenov.dev
          parentRefs:
            - name: internal
              namespace: istio-gateway
          matches:
            - path:
                type: PathPrefix
                value: /
    crds:
      enabled: true
      ## The CRD upgrade job mitigates the limitation of helm not being able to upgrade CRDs.
      ## The job will apply the CRDs to the cluster before the operator is deployed, using helm hooks.
      ## It deploy a corresponding clusterrole, clusterrolebinding and serviceaccount to apply the CRDs.
      ## This feature is in preview, off by default and may change in the future.
      upgradeJob:
        enabled: true
        forceConflicts: true
      image:
        busybox:
          registry: docker.io
          repository: busybox
          tag: "1.37"
          sha: ""
          pullPolicy: IfNotPresent
        kubectl:
          registry: registry.k8s.io
          repository: kubectl
          # defaults to the Kubernetes version
          tag: ""
          sha: ""
          pullPolicy: IfNotPresent
sops:
  age:
    - recipient: age1mq6usjzvvxvcp7tl03yjdqd0kgjhhvhz48kmg86p43nhx0jc75jssw0kfn
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBvd2dkWC9RbjRTTzVCcjR5
        R3h0S3kvSHA1K3VjaDhjY3BoSzlnV2Y5RTFvCkJER095MVB6VEhDMVBoNUM1TkZN
        SEFhN3k1WkRsTFUwVmhrTEhGc0g1ZlkKLS0tIEp4MFNZbkxaZGZDNTlWL0ZYMjVP
        MnZTaUoxakkzSS9yd2hxL1NrSXVoZjQKq8DBQpSfBIe+49H9T4eFXYdUi7ZRtjMd
        1St9o6vw0RmzNqGTtczmKZs42K2Cf3gE09b40TnFWzh/1AkhtkQuNQ==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2026-01-14T23:32:11Z"
  mac: ENC[AES256_GCM,data:RSneOamRAdxSkyLVxpZPzfmKJAQwXoFtq4ka2X1hi6TUW5CwieVxzrWScYRbYQxoySD5RoJlnsugmMHSI96TXFDtqHZAA6DYek20ettwO2vuFq8Yp9QvwGJ0ht+f042yJOWilBAdK6hnCGB07xXuS9b4L5E6UcZKBKze+9XlFZM=,iv:iAFeVBOKojgRiEvX7yh/REIYQs22ixGaMdNdzTfKeKA=,tag:tl6t6t5ijhy0bcoZ8aNYZg==,type:str]
  encrypted_regex: (?i)password|webhook_url|token|key
  version: 3.11.0
