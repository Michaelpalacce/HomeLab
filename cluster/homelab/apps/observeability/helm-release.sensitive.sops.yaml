apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: observeability
  namespace: observeability
spec:
  interval: 1h
  install:
    createNamespace: true
  chart:
    spec:
      chart: kube-prometheus-stack
      version: 80.14.3
      interval: 1h
      sourceRef:
        kind: HelmRepository
        name: kube-prometheus-stack
        namespace: flux-system
  values:
    defaultRules:
      create: true
      rules:
        alertmanager: true
        etcd: true
        configReloaders: true
        general: true
        k8sContainerCpuUsageSecondsTotal: true
        k8sContainerMemoryCache: true
        k8sContainerMemoryRss: true
        k8sContainerMemorySwap: true
        k8sContainerResource: true
        k8sContainerMemoryWorkingSetBytes: true
        k8sPodOwner: true
        kubeApiserverAvailability: true
        kubeApiserverBurnrate: true
        kubeApiserverHistogram: true
        kubeApiserverSlos: true
        kubeControllerManager: false
        kubelet: true
        kubeProxy: false
        kubePrometheusGeneral: true
        kubePrometheusNodeRecording: true
        kubernetesApps: true
        kubernetesResources: true
        kubernetesStorage: true
        kubernetesSystem: true
        kubeSchedulerAlerting: false
        kubeSchedulerRecording: false
        kubeStateMetrics: true
        network: true
        node: true
        nodeExporterAlerting: true
        nodeExporterRecording: true
        prometheus: true
        prometheusOperator: true
        windows: false
    prometheus-node-exporter:
      containerSecurityContext:
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL
    prometheus:
      prometheusSpec:
        scrapeInterval: 60s
        scrapeTimeout: 30s
        retention: 30d
        retentionSize: 10GiB
        storageSpec:
          volumeClaimTemplate:
            spec:
              storageClassName: longhorn
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 15Gi
        serviceMonitorNamespaceSelector:
          matchLabels:
            monitoring.coreos.com/serviceMonitor: "true"
      route:
        main:
          # -- Enables or disables the route
          enabled: true
          apiVersion: gateway.networking.k8s.io/v1
          kind: HTTPRoute
          annotations:
            gethomepage.dev/enabled: "true"
            gethomepage.dev/description: Metrics Aggregator.
            gethomepage.dev/group: Monitoring
            gethomepage.dev/icon: prometheus
            gethomepage.dev/name: Prometheus
          hostnames:
            - prometheus.sgenov.dev
          parentRefs:
            - name: internal
              namespace: istio-gateway
          matches:
            - path:
                type: PathPrefix
                value: /
    alertmanager:
      config:
        global:
          resolve_timeout: 5m
        inhibit_rules:
          - source_matchers:
              - severity = critical
            target_matchers:
              - severity =~ warning|info
            equal:
              - namespace
              - alertname
          - source_matchers:
              - severity = warning
            target_matchers:
              - severity = info
            equal:
              - namespace
              - alertname
          - source_matchers:
              - alertname = InfoInhibitor
            target_matchers:
              - severity = info
            equal:
              - namespace
          - target_matchers:
              - alertname = InfoInhibitor
        route:
          group_by:
            - alertname
            - namespace
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 12h
          receiver: discord
          routes:
            - receiver: "null"
              matchers:
                - alertname="PrometheusDuplicateTimestamps"
              continue: false
            - receiver: "null"
              matchers:
                - alertname="Watchdog"
              continue: false
            # Match everything else
            - receiver: discord
        receivers:
          - name: "null"
          - name: discord
            discord_configs:
              - webhook_url: ENC[AES256_GCM,data:U1q2IgygFez180LSkyNxDsPKZq8XrrP/LjGMaf3ICI94nL3KG+rkG7GF+oC/0ahn8IQwIm4aDmRlgKa03pRIoOta1SKw0yegTD34RK3ukDZ2WTny+nb31kBtbk954tVlVXtm2U0Jcz725sjYB5j46P7zvKo0nE/j6Q==,iv:L2R4XLr1sarmqW3PVEyf4mwtpMeMKRWRSJJl/OOUlCI=,tag:vQ8WBo1OSOKvlfc3mR6+NQ==,type:str]
                send_resolved: true
        templates:
          - /etc/alertmanager/config/*.tmpl
      alertmanagerSpec:
        alertmanagerConfigSelector:
          matchLabels:
            # This is so we can create AlertManager configs targeting `default`
            alertmanagerConfig: default
        storage:
          volumeClaimTemplate:
            spec:
              storageClassName: longhorn
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 5Gi
      route:
        main:
          # -- Enables or disables the route
          enabled: true
          apiVersion: gateway.networking.k8s.io/v1
          kind: HTTPRoute
          annotations:
            gethomepage.dev/enabled: "true"
            gethomepage.dev/description: Handles Prometheus Alerts
            gethomepage.dev/group: Monitoring
            gethomepage.dev/icon: alertmanager
            gethomepage.dev/name: Alertmanager
          hostnames:
            - alertmanager.sgenov.dev
          parentRefs:
            - name: internal
              namespace: istio-gateway
          matches:
            - path:
                type: PathPrefix
                value: /
    grafana:
      adminUser: admin
      adminPassword: ENC[AES256_GCM,data:z7NCGFOwAq3DW1K0ucbSfmqoN60j9vlEDj2qpmnCGuBkobTIGD3tW3RyL6V93DIomuaiKg==,iv:PahIeR+GRj75DggLdFxl7wdfTzBogS286SGWc+ikiuc=,tag:X/OTRF3tltYaXxTeCEYx8w==,type:str]
      persistence:
        enabled: true
        type: sts
        storageClassName: longhorn
        accessModes:
          - ReadWriteOnce
        size: 2Gi
        finalizers:
          - kubernetes.io/pvc-protection
      route:
        main:
          # -- Enables or disables the route
          enabled: true
          apiVersion: gateway.networking.k8s.io/v1
          kind: HTTPRoute
          annotations: null
          gethomepage.dev/enabled: "true"
          gethomepage.dev/description: Nice observeability graphs.
          gethomepage.dev/group: Monitoring
          gethomepage.dev/icon: grafana
          gethomepage.dev/name: Grafana
          gethomepage.dev/widget.type: grafana
          gethomepage.dev/widget.url: https://grafana.sgenov.dev
          gethomepage.dev/widget.version: "2"
          gethomepage.dev/widget.alerts: alertmanager
          gethomepage.dev/widget.username: admin
          gethomepage.dev/widget.password: ENC[AES256_GCM,data:yGwzTp2V2a+a25QvvsqWtPquUrps22zAY+IUG8VnzF37cs1ByEhrVPHdMmbs4Ua7kbCHCQ==,iv:wySiycULpS7PUtJxjRT5hFRPtSf3Dlg2aX1g68L/CPE=,tag:XY0bKuD9bzaMotEoTT2D2A==,type:str]
          hostnames:
            - grafana.sgenov.dev
          parentRefs:
            - name: internal
              namespace: istio-gateway
          matches:
            - path:
                type: PathPrefix
                value: /
    crds:
      enabled: true
      ## The CRD upgrade job mitigates the limitation of helm not being able to upgrade CRDs.
      ## The job will apply the CRDs to the cluster before the operator is deployed, using helm hooks.
      ## It deploy a corresponding clusterrole, clusterrolebinding and serviceaccount to apply the CRDs.
      ## This feature is in preview, off by default and may change in the future.
      upgradeJob:
        enabled: true
        forceConflicts: true
      image:
        busybox:
          registry: docker.io
          repository: busybox
          tag: "1.37"
          sha: ""
          pullPolicy: IfNotPresent
        kubectl:
          registry: registry.k8s.io
          repository: kubectl
          # defaults to the Kubernetes version
          tag: ""
          sha: ""
          pullPolicy: IfNotPresent
sops:
  age:
    - recipient: age1mq6usjzvvxvcp7tl03yjdqd0kgjhhvhz48kmg86p43nhx0jc75jssw0kfn
      enc: |
        -----BEGIN AGE ENCRYPTED FILE-----
        YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBWSmFhbFZ6UWFYSHFDOUZQ
        YXhBYVJqTlVick5IV3YxL1FVczdJVm1IYnd3CjFVbHR5bXhDK1hpTzRpRC93TElL
        eFNMdGhaYWQ2YWtURXRyWnVaM0NZM0EKLS0tIHBaSDVCSE9kTXgxU2VrQ0E5OTJl
        b0oyOXUyMVZZRHMyMWh4YWN4b1hubEkKF98BEkg3eoEpCvMcvZRyIdBmR1oUYfak
        lyhID6EEc89+ABbqRRBtSWYCXKN8FVtqPmO6PTbdwZaT7jcjf/tkyA==
        -----END AGE ENCRYPTED FILE-----
  lastmodified: "2026-01-14T06:57:32Z"
  mac: ENC[AES256_GCM,data:7GKd3uW7WucLyhs4IEvsFDs6s6JKTN/Ug/NeI1CF3ymOdPMSyS1pgRoJo1+wYPPXn1Hc1aT9owMPQb99gQfR61pXC7WbRDm89E0o9dvJlSHVr63bCPB2OjGEt1+ACF4pREvvqwg0Zxcl1inYFiBi0brciXkebaYupPIvqSkKwZA=,iv:yCH7H7UFuDc4009BAS3DXw7PNgWFfROb77NaUzbUYKA=,tag:FV87n3r68/+YmEIMuc9CWw==,type:str]
  encrypted_regex: (?i)password|webhook_url|token|key
  version: 3.11.0
