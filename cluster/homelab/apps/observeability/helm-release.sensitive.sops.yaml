apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: observeability
    namespace: observeability
spec:
    interval: 1h
    install:
        createNamespace: true
    chart:
        spec:
            chart: kube-prometheus-stack
            version: 77.11.0
            interval: 1h
            sourceRef:
                kind: HelmRepository
                name: kube-prometheus-stack
                namespace: flux-system
    values:
        defaultRules:
            create: true
            rules:
                alertmanager: true
                etcd: true
                configReloaders: true
                general: true
                k8sContainerCpuUsageSecondsTotal: true
                k8sContainerMemoryCache: true
                k8sContainerMemoryRss: true
                k8sContainerMemorySwap: true
                k8sContainerResource: true
                k8sContainerMemoryWorkingSetBytes: true
                k8sPodOwner: true
                kubeApiserverAvailability: true
                kubeApiserverBurnrate: true
                kubeApiserverHistogram: true
                kubeApiserverSlos: true
                kubeControllerManager: false
                kubelet: true
                kubeProxy: false
                kubePrometheusGeneral: true
                kubePrometheusNodeRecording: true
                kubernetesApps: true
                kubernetesResources: true
                kubernetesStorage: true
                kubernetesSystem: true
                kubeSchedulerAlerting: false
                kubeSchedulerRecording: false
                kubeStateMetrics: true
                network: true
                node: true
                nodeExporterAlerting: true
                nodeExporterRecording: true
                prometheus: true
                prometheusOperator: true
                windows: false
        prometheus-node-exporter:
            containerSecurityContext:
                readOnlyRootFilesystem: true
                capabilities:
                    drop:
                        - ALL
        # prometheusOperator:
        #   networkPolicy:
        #       enabled: true
        prometheus:
            # networkPolicy:
            #     enabled: true
            prometheusSpec:
                scrapeInterval: 60s
                scrapeTimeout: 30s
                retention: 10d
                retentionSize: 10GiB
                storageSpec:
                    volumeClaimTemplate:
                        spec:
                            storageClassName: longhorn
                            accessModes:
                                - ReadWriteOnce
                            resources:
                                requests:
                                    storage: 15Gi
                serviceMonitorNamespaceSelector:
                    matchLabels:
                        monitoring.coreos.com/serviceMonitor: "true"
            ingress:
                enabled: true
                ingressClassName: nginx
                hosts:
                    - prometheus.sgenov.dev
                paths: []
                tls:
                    - secretName: ingress
                      hosts:
                        - '*.sgenov.dev'
        alertmanager:
            # networkPolicy:
            #     enabled: true
            config:
                global:
                    resolve_timeout: 5m
                inhibit_rules:
                    - source_matchers:
                        - severity = critical
                      target_matchers:
                        - severity =~ warning|info
                      equal:
                        - namespace
                        - alertname
                    - source_matchers:
                        - severity = warning
                      target_matchers:
                        - severity = info
                      equal:
                        - namespace
                        - alertname
                    - source_matchers:
                        - alertname = InfoInhibitor
                      target_matchers:
                        - severity = info
                      equal:
                        - namespace
                    - target_matchers:
                        - alertname = InfoInhibitor
                route:
                    group_by:
                        - alertname
                        - namespace
                    group_wait: 30s
                    group_interval: 5m
                    repeat_interval: 12h
                    receiver: discord
                    routes:
                        - receiver: "null"
                          matchers:
                            - alertname="PrometheusDuplicateTimestamps"
                          continue: false
                        - receiver: "null"
                          matchers:
                            - alertname="Watchdog"
                          continue: false
                        # Match everything else
                        - receiver: discord
                receivers:
                    - name: "null"
                    - name: discord
                      discord_configs:
                        - webhook_url: ENC[AES256_GCM,data:fxtoqmBVmWzh2XZ0jSoezROngAcmTiiwmt/8y2FSt//0edIB7El6eUnKCWEay+icrR3GutuDu9YRwGtxgN7Y3/pHKpQK6unISGMbAqnv8RwSRn54S0dEQoFnsSvV0g0bTvgW/CuKYCokdODzsOzmG7oURlqnhsOR0A==,iv:JUjNfu8Xb2Pn8+1foAmi3hoI8kl+KVosolnVvgY3inc=,tag:QLTjGY6PBah+Ya503ywSbg==,type:str]
                          send_resolved: true
                templates:
                    - /etc/alertmanager/config/*.tmpl
            alertmanagerSpec:
                alertmanagerConfigSelector:
                    matchLabels:
                        # This is so we can create AlertManager configs targeting `default`
                        alertmanagerConfig: default
                storage:
                    volumeClaimTemplate:
                        spec:
                            storageClassName: longhorn
                            accessModes:
                                - ReadWriteOnce
                            resources:
                                requests:
                                    storage: 5Gi
            ingress:
                enabled: true
                ingressClassName: nginx
                annotations:
                    gethomepage.dev/enabled: "true"
                    gethomepage.dev/description: Handles Prometheus Alerts
                    gethomepage.dev/group: Monitoring
                    gethomepage.dev/icon: alertmanager
                    gethomepage.dev/name: Alertmanager
                hosts:
                    - alertmanager.sgenov.dev
                path: /
                tls:
                    - secretName: ingress
                      hosts:
                        - '*.sgenov.dev'
        grafana:
            adminUser: admin
            adminPassword: ENC[AES256_GCM,data:fXN7TR9A+ipD+W/tvd/YGDVvHacB/jmzrJfUXVJLQA1qtfllnPX4NRT6OfOXBcVAoL4smg==,iv:+DCuBe4GHjO1cG/F94HDdgffEwg9dl86DMyGQqw6VZs=,tag:t4uSff63l7nCmERCUjw5sg==,type:str]
            dashboards:
                default:
                    Trivy:
                        gnetId: 17813
                        revision: 2
            persistence:
                enabled: true
                type: sts
                storageClassName: longhorn
                accessModes:
                    - ReadWriteOnce
                size: 2Gi
                finalizers:
                    - kubernetes.io/pvc-protection
            ingress:
                ## If true, Grafana Ingress will be created
                ##
                enabled: true
                ingressClassName: nginx
                annotations:
                    gethomepage.dev/enabled: "true"
                    gethomepage.dev/description: Nice observeability graphs.
                    gethomepage.dev/group: Monitoring
                    gethomepage.dev/icon: grafana
                    gethomepage.dev/name: Grafana
                    gethomepage.dev/widget.type: grafana
                    gethomepage.dev/widget.url: https://grafana.sgenov.dev
                    gethomepage.dev/widget.version: "2"
                    gethomepage.dev/widget.alerts: alertmanager
                    gethomepage.dev/widget.username: admin
                    gethomepage.dev/widget.password: ENC[AES256_GCM,data:pKF6RPh8scqzLxEFN8iupflXj4ACMdQ9cU/fMroDgc3K82h2xhG9gqggDhgJGospiuTFbw==,iv:B/0fyYfyFPXDkp+LAjiQ7RBnWzBVtrfYVPYAOw3Ml4I=,tag:1Eg6gcANurD0ft5XxFexBw==,type:str]
                hosts:
                    - grafana.sgenov.dev
                path: /
                tls:
                    - secretName: ingress
                      hosts:
                        - '*.sgenov.dev'
        crds:
            enabled: true
            ## The CRD upgrade job mitigates the limitation of helm not being able to upgrade CRDs.
            ## The job will apply the CRDs to the cluster before the operator is deployed, using helm hooks.
            ## It deploy a corresponding clusterrole, clusterrolebinding and serviceaccount to apply the CRDs.
            ## This feature is in preview, off by default and may change in the future.
            upgradeJob:
                enabled: true
                forceConflicts: false
sops:
    age:
        - recipient: age1mq6usjzvvxvcp7tl03yjdqd0kgjhhvhz48kmg86p43nhx0jc75jssw0kfn
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBOYkI1SVVoS3JvSFcvMFY3
            L1hLMGRQY0w0UEVHZ1B0TkFCQzZaZ2xVTEhzCjNKazJUTGE1UERpakVudy9LWXNi
            NFVyRUNiNDRZSDdJaUhuZkRHZkNDUkEKLS0tIHhmdUxQeExWU3cweGQvNFRBcGlu
            N1V3RW9WQzZDVjgxcm1uczRCSXJMYjQKnSqDkkqP3W5HPdeYWFUzZRxSqoxizQpK
            h7jUHjbiPVv32yO8fabTY/Yx1oehS+4jnGiaUJnPmncXHze2BwgCVw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2025-09-25T16:42:25Z"
    mac: ENC[AES256_GCM,data:HFUzoRP4ATfBx3Wfhc9FdK+x6E2p41zmE5v28Wk4EM6co/+RzlwYHBOnmn+M+dcMFSokfYUwIiMEcorObJ1szZL9lOtdmUWkMlYzhQYApy+/kdJV5uizg3RXU2TXJZcGurhXNYInRpofK7ka+wvLHDKktOVPM0EIc0GUDTAhLy0=,iv:PJJHsJdnrm9u3Rnn4WapIP80UXlFCpL5u9weTZJmusA=,tag:lqRBociZSzNl2oSIGvor4A==,type:str]
    encrypted_regex: (?i)password|webhook_url|token|key
    version: 3.10.2
