apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: generate-networkpolicy-existing
  annotations:
    policies.kyverno.io/title: Generate NetworkPolicy to Existing Namespaces
    policies.kyverno.io/category: Other
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Namespace, NetworkPolicy
    kyverno.io/kyverno-version: 1.7.0
    policies.kyverno.io/minversion: 1.7.0
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      A NetworkPolicy is often a critical piece when provisioning new Namespaces,
      but there may be existing Namespaces which also need the same resource. Creating
      each one individually or manipulating each Namespace in order to trigger creation
      is additional overhead. This policy creates a new NetworkPolicy for existing
      Namespaces which results in a default deny behavior and labels it with created-by=kyverno.
spec:
  generateExisting: true
  rules:
  - name: generate-existing-networkpolicy
    exclude:
      any:
      - resources:
          namespaces:
            - longhorn-system
            - kyverno
            - kube-system
            - flux-system
            - velero # We want to communicate to all namespaces for backup reasons
            - observeability # Has it's own

            # These work together, have to create a special policy just for them
            - tika
            - gotenberg
            - paperless-ngx

            # WILL HAVE TO FIX THIS LATER
            - uptimekuma
            - ingress-nginx
            - system-upgrade
            - homepage
            - firefly
    match:
      any:
      - resources:
          kinds:
          - Namespace
    generate:
      kind: NetworkPolicy
      apiVersion: networking.k8s.io/v1
      name: "{{request.object.metadata.name}}-default-deny"
      namespace: "{{request.object.metadata.name}}"
      synchronize: true
      data:
        metadata:
          labels:
            created-by: kyverno
        spec:
          podSelector: {}
          policyTypes:
          - Egress
          egress: 
          # Allow everywhere but not internally, don't want it communicating to local network
          - to:
            - ipBlock:
                cidr: 0.0.0.0/0
                except:
                - 10.0.0.0/8   # RFC 1918 - Class A private
                - 172.16.0.0/12 # RFC 1918 - Class B private
                - 192.168.0.0/16 # RFC 1918 - Class C private
          # It's ok internally to the namespace
          - to:
            - namespaceSelector:
                matchLabels:
                  kubernetes.io/metadata.name: "{{request.object.metadata.name}}"
          # DNS is allowed (CoreDNS)
          - to:
            - namespaceSelector:
                matchLabels:
                  kubernetes.io/metadata.name: kube-system
            ports:
            - protocol: UDP
              port: 53
            - protocol: TCP
              port: 53
