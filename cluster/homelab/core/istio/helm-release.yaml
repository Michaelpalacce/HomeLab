---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: istio
  namespace: istio
spec:
  interval: 1h
  install:
    createNamespace: true
    crds: CreateReplace
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  chart:
    spec:
      chart: istio/gateway
      version: 1.28.0
      interval: 1h
      sourceRef:
        kind: HelmRepository
        name: istio
        namespace: flux-system
  values:
    rbac:
      enabled: true

    serviceAccount:
      create: true
      annotations: {}

    podAnnotations:
      prometheus.io/port: "15020"
      prometheus.io/scrape: "true"
      prometheus.io/path: "/stats/prometheus"
      inject.istio.io/templates: "gateway"
      sidecar.istio.io/inject: "true"

    # Define the security context for the pod.
    # If unset, this will be automatically set to the minimum privileges required to bind to port 80 and 443.
    # On Kubernetes 1.22+, this only requires the `net.ipv4.ip_unprivileged_port_start` sysctl.
    securityContext:
      capabilities:
        drop:
          - ALL
    service:
      type: LoadBalancer
      # Set to a specific ClusterIP, or "" for automatic assignment
      clusterIP: ""
      ports:
        - name: status-port
          port: 15021
          protocol: TCP
          targetPort: 15021
        - name: http2
          port: 80
          protocol: TCP
          targetPort: 80
        - name: https
          port: 443
          protocol: TCP
          targetPort: 443
      annotations: {}
      loadBalancerIP: "192.168.1.19"
      loadBalancerSourceRanges: []
      externalTrafficPolicy: ""
      externalIPs: []
      ipFamilyPolicy: ""
      ipFamilies: []

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 2000m
        memory: 1024Mi

    autoscaling:
      enabled: true
      minReplicas: 1
      maxReplicas: 5
      targetCPUUtilizationPercentage: 80
      targetMemoryUtilizationPercentage: {}
      autoscaleBehavior: {}

    # Labels to apply to all resources
    labels:
      # By default, don't enroll gateways into the ambient dataplane
      "istio.io/dataplane-mode": none

    tolerations:
      - key: "CriticalAddonsOnly"
        operator: "Equal"
        effect: "NoSchedule"
        value:

    # Configure this to a higher priority class in order to make sure your Istio gateway pods
    # will not be killed because of low priority class.
    # Refer to https://kubernetes.io/docs/concepts/configuration/pod-priority-preemption/#priorityclass
    # for more detail.
    priorityClassName: "critical-priority"

    # When enabled, a default NetworkPolicy for gateways will be created
    global:
      networkPolicy:
        enabled: true
